<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>é˜¿å—å°‘å„¿ç¼–ç¨‹å¤§å±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #fff7ee;
        font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
      }

      body {
        min-height: 100vh;
      }

      header {
        background: #ff8500;
        color: #fff;
        padding: 20px 0 7px 40px;
        font-size: 32px;
        font-weight: bold;
        letter-spacing: 2px;
      }

      .main-layout {
        display: flex;
        height: calc(100vh - 60px);
        max-width: 2200px;
        margin: 0 auto;
        transition: 0.3s;
      }

      .left-board {
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 8px 24px #ff850040;
        margin: 0 0 0 24px;
        padding: 18px 14px 14px 18px;
        min-width: 420px;
        max-width: 560px;
        width: 440px;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .left-board h2 {
        font-size: 24px;
        color: #ff8500;
        text-align: center;
        margin-bottom: 10px;
        letter-spacing: 1px;
        font-weight: bold;
      }

      .board-table-area {
        flex: 1 1 auto;
        overflow-y: auto;
        height: 0;
      }

      .board-table {
        width: 100%;
        font-size: 16px;
        text-align: center;
        border-radius: 18px;
        border-collapse: separate;
        border-spacing: 0;
        overflow: hidden;
        min-width: 530px;
        box-shadow: 0 2px 16px #ff85001a;
      }

      .board-table th {
        background: #fff3e0;
        color: #ff8500;
        font-weight: bold;
        padding: 11px 2px;
        font-size: 16px;
        border-bottom: 2px solid #ffd699;
        letter-spacing: 1px;
      }

      .board-table td {
        padding: 9px 2px;
        font-size: 16px;
        border-bottom: 1px solid #ffe0b2;
        transition: background 0.15s;
        cursor: pointer;
      }

      .board-table tr:nth-child(even) td {
        background: #fff9f3;
      }

      .board-table tr:hover td {
        background: #fff2e2 !important;
      }

      .right-charts {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 24px;
        margin: 0 18px 0 22px;
        min-width: 0;
        align-content: center;
        height: 100%;
      }

      .chart-card {
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 8px 24px #ff850040;
        padding: 20px 14px 12px 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 0;
        min-height: 280px;
        height: 93%;
      }

      .chart-card h3 {
        color: #ff8500;
        font-size: 20px;
        margin-bottom: 12px;
        font-weight: bold;
        text-align: center;
        letter-spacing: 1px;
      }

      .echart-box {
        width: 100%;
        height: 240px;
        min-width: 0;
        flex: 1 1 auto;
      }

      .board-table-area::-webkit-scrollbar {
        width: 7px;
        background: #fff7ee;
      }

      .board-table-area::-webkit-scrollbar-thumb {
        background: #ffecbc;
        border-radius: 6px;
      }

      .board-table-area::-webkit-scrollbar-thumb:hover {
        background: #ffd699;
      }

      .user-detail-view {
        display: none;
        flex-direction: column;
        align-items: center;
        height: 100%;
        width: 100vw;
      }

      .user-card {
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 8px 24px #ff850040;
        padding: 20px 44px 12px 44px;
        margin: 18px 0 24px 0;
        display: flex;
        align-items: center;
        gap: 38px;
      }

      .user-info-main {
        font-size: 28px;
        color: #ff8500;
        font-weight: bold;
      }

      .user-info-sec {
        font-size: 17px;
        color: #333;
        margin-top: 6px;
      }

      .back-btn {
        background: #ff8500;
        color: #fff;
        font-size: 18px;
        border: none;
        border-radius: 10px;
        padding: 10px 25px;
        margin-bottom: 18px;
        cursor: pointer;
        transition: 0.15s;
        font-weight: bold;
      }

      .back-btn:hover {
        background: #ff5f00;
      }

      .charts-flex {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 24px;
        width: 96%;
        margin: 0 auto;
        align-content: center;
      }

      .cur-user {
        background: linear-gradient(90deg, #ffefcc 70%, #ffb70018);
        color: #ff5f00;
        font-weight: bold;
      }

      .chart-card#user-bar-card {
        min-height: 340px;
        padding-top: 28px;
      }

      /* --- å¿…åšé¢˜å®Œæˆæƒ…å†µåŒºåŸŸ --- */
      .must-section {
        margin: 30px auto 0 auto;
        width: 98%;
        background: #fff7f0;
        border-radius: 18px;
        box-shadow: 0 4px 16px #ffd69944;
        padding: 20px 12px 18px 18px;
        max-width: 800px;
      }

      .must-title {
        font-size: 21px;
        color: #ff8500;
        font-weight: bold;
        margin-bottom: 7px;
        text-align: left;
        letter-spacing: 1px;
      }

      .must-cat {
        font-size: 17px;
        color: #ff8500;
        font-weight: bold;
        margin: 17px 0 8px 0;
      }

      .must-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        margin-bottom: 3px;
      }

      .must-item {
        font-size: 15px;
        padding: 3px 12px;
        border-radius: 12px;
        background: #eee;
        color: #bdbdbd;
        border: 1.3px solid #ececec;
        transition: background 0.2s, color 0.2s, border 0.2s;
        margin-bottom: 3px;
        user-select: none;
        cursor: default;
        font-family: Consolas, "å¾®è½¯é›…é»‘", Arial, sans-serif;
        box-shadow: 0 1px 3px #ffb70011;
      }

      .must-item.done {
        background: #c5f8d5;
        color: #119642;
        border: 1.5px solid #88e26f;
        font-weight: bold;
      }

      .header-flex {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 56px 0 0;
        /* è¿™é‡Œ 40px å°±æ˜¯å³ä¾§çš„è·ç¦»ï¼Œå¯ä»¥è°ƒå¤§è°ƒå° */
        background: #ff8500;
        width: 98vw;
        min-height: 62px;
      }

      .header-flex header {
        background: none;
        color: #fff;
        font-size: 32px;
        font-weight: bold;
        letter-spacing: 2px;
        padding: 20px 0 7px 40px;
        box-shadow: none;
        margin: 0;
      }

      .search-bar-inner {
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 2px 10px #ffbb3230;
        border: 2px solid #ffbb32;
        padding: 3px 8px 3px 14px;
        transition: box-shadow 0.2s, border-color 0.2s;
        max-width: 350px;
        width: 38vw;
        min-width: 140px;
        margin-left: 16px;
      }

      .search-bar-inner:focus-within {
        box-shadow: 0 4px 16px #ff850066;
        border-color: #ff8500;
      }

      .search-icon {
        font-size: 20px;
        color: #ff8500;
        margin-right: 7px;
        margin-top: 2px;
      }

      .search-bar-inner input {
        flex: 1 1 auto;
        border: none;
        outline: none;
        background: transparent;
        font-size: 16px;
        padding: 8px 4px 8px 2px;
        color: #ff8500;
        font-weight: 500;
        letter-spacing: 1px;
        border-radius: 0;
      }

      .search-bar-inner input::placeholder {
        color: #d2aa60;
        font-size: 14px;
      }

      .search-bar-inner button {
        border: none;
        background: #ff8500;
        color: #fff;
        font-size: 16px;
        font-weight: bold;
        padding: 7px 18px;
        border-radius: 18px;
        margin-left: 7px;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px #ffbb3222;
      }

      .search-bar-inner button:hover {
        background: #ff5f00;
        box-shadow: 0 4px 14px #ffbb3233;
      }

      @media (max-width: 900px) {
        .header-flex header {
          font-size: 20px;
          padding: 16px 0 6px 16px;
        }

        .search-bar-inner {
          max-width: 200px;
          width: 36vw;
          min-width: 100px;
        }
      }

      @media (max-width: 600px) {
        .header-flex {
          flex-direction: column;
          align-items: stretch;
          padding: 0;
          min-height: unset;
        }

        .header-flex header {
          font-size: 18px;
          padding: 12px 0 5px 9px;
          text-align: left;
        }

        .search-bar-inner {
          max-width: 95vw;
          width: 94vw;
          margin: 6px auto 2px auto;
        }
      }

      @media (max-width: 1100px) {
        .main-layout {
          flex-direction: column;
          height: auto;
        }

        .right-charts,
        .charts-flex {
          grid-template-columns: 1fr;
          grid-template-rows: repeat(4, 1fr);
        }

        .right-charts,
        .charts-flex {
          gap: 18px;
        }

        .left-board {
          width: 99vw;
          max-width: unset;
          min-width: unset;
          margin: 0 0 20px 0;
        }

        .must-section {
          padding: 12px 5vw 10px 5vw;
        }
      }

      @media (max-width: 700px) {
        header {
          font-size: 20px;
          padding-left: 8px;
        }

        .left-board h2 {
          font-size: 16px;
        }

        .user-card {
          flex-direction: column;
          gap: 8px;
          padding: 10px 6vw;
        }

        .user-info-main {
          font-size: 20px;
        }

        .user-info-sec {
          font-size: 13px;
        }

        .charts-flex {
          width: 100%;
          gap: 8px;
        }

        .chart-card#user-bar-card {
          min-height: 260px;
          padding-top: 14px;
        }

        .must-section {
          max-width: 98vw;
          font-size: 14px;
        }
      }
    </style>
  </head>

  <body>
    <div class="header-flex">
      <header
        id="mainTitle"
        style="
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
        "
      >
        <span>ANANCODE Â· é˜¿å—ä¿¡å¥¥</span>
        <span
          style="
            font-size: 13px;
            color: #f8f7f7;
            margin-left: 18px;
            font-style: italic;
          "
          >Â©2025 Fu</span
        >
      </header>

      <div class="search-bar-inner">
        <span class="search-icon">ğŸ”</span>
        <input
          id="stuSearchInput"
          type="text"
          placeholder="è¾“å…¥å­¦ç”Ÿå§“åï¼Œå›è½¦æˆ–ç‚¹æœç´¢"
          autocomplete="off"
          onkeydown="if(event.key==='Enter'){searchStudent();}"
        />
        <button onclick="searchStudent()">æœç´¢</button>
      </div>
    </div>

    <div class="main-layout" id="mainView" style="display: none">
      <div class="left-board">
        <h2>åˆ·é¢˜å¤©æ¢¯æ¦œ</h2>
        <div class="board-table-area" id="studentTableArea">
          <table class="board-table">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>å§“å</th>
                <th>æ€»æ•°</th>
                <th>å…¥é—¨</th>
                <th>æ™®åŠ-</th>
                <th>æ™®åŠ/æé«˜-</th>
                <th>é«˜éš¾åº¦</th>
              </tr>
            </thead>
            <tbody id="student-table-body"></tbody>
          </table>
        </div>
      </div>
      <div class="right-charts">
        <div class="chart-card">
          <h3>å·²é€šè¿‡é¢˜ç›®ç»Ÿè®¡</h3>
          <div id="main-pie" class="echart-box"></div>
        </div>
        <div class="chart-card" style="position: relative">
          <h3>æ¯å‘¨è¿›æ­¥æ’è¡Œæ¦œ</h3>
          <div
            id="growth-rank-view"
            style="
              width: 100%;
              min-height: 210px;
              display: flex;
              align-items: flex-end;
              justify-content: center;
              gap: 38px;
              margin-top: 12px;
            "
          ></div>
        </div>

        <div class="chart-card">
          <h3>25å¹´8æœˆèµ›æˆç»©å‰8å</h3>
          <div id="main-bar" class="echart-box"></div>
        </div>
        <div class="chart-card">
          <h3>ç­çº§éš¾åº¦åˆ†å¸ƒå¯¹æ¯”</h3>
          <div id="main-radar" class="echart-box"></div>
        </div>
      </div>
    </div>
    <!-- ä¸ªäººè¯¦æƒ…é¡µ -->
    <div class="user-detail-view" id="userDetailView">
      <div class="user-card" id="userCard"></div>
      <div class="charts-flex">
        <div class="chart-card">
          <h3>åšé¢˜éš¾åº¦ç»Ÿè®¡</h3>
          <div id="user-pie" class="echart-box"></div>
        </div>
        <div class="chart-card">
          <h3>æ¯å‘¨åšé¢˜æ•°å¢é‡</h3>
          <div id="user-line" class="echart-box"></div>
        </div>
        <div class="chart-card" id="user-bar-card">
          <h3 id="user-bar-title">æœ¬æœˆæœˆèµ›åˆ†æ•°</h3>
          <div
            id="user-bar"
            class="echart-box"
            style="height: 280px; max-width: 330px; margin: 0 auto"
          ></div>
          <div id="user-bar-info"></div>
          <!-- æ–°å¢ï¼šåœ¨ä»ªè¡¨ç›˜ä¸‹æ–¹åŠ ä¸€è¡Œ -->
        </div>
        <div class="chart-card">
          <h3>éš¾åº¦åˆ†å¸ƒå¯¹æ¯”</h3>
          <div id="user-radar" class="echart-box"></div>
        </div>
      </div>
      <!-- å¿…åšé¢˜èŒƒç•´å®Œæˆæƒ…å†µå±•ç¤ºåŒºï¼ˆæ–°å¢ï¼‰ -->
      <div class="must-section" id="mustSection" style="display: none">
        <div class="must-title">å†…å®¹èŒƒç•´å¿…åšé¢˜å®Œæˆæƒ…å†µ</div>
        <div id="mustMapArea"></div>
      </div>
    </div>

    <script>
      const diffList = [
        { name: "å…¥é—¨", key: "r", color: "#fa6e7e" },
        { name: "æ™®åŠ-", key: "p", color: "#ffbe32" },
        { name: "æ™®åŠ/æé«˜-", key: "t", color: "#3ec653" },
        { name: "é«˜éš¾åº¦", key: "h", color: "#468fdf" },
      ];
      // userGrowthFiles: ä½ ç»´æŠ¤çš„æœ€è¿‘å››å‘¨æ–‡ä»¶åæ•°ç»„ï¼Œæ¯”å¦‚
      const userGrowthFiles = [
        "data_2025-07-20.json",
        "data_2025-07-26.json",
        "data_2025-08-04.json",
      ];

      // è¿™ä¸ªå‡½æ•°ä¼šè¿”å› 4 ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«æ˜¯æ¯ä¸ªéš¾åº¦å¯¹åº”4å‘¨çš„ç´¯è®¡æ•°é‡
      async function getUserTotalSeries(name) {
        // ä¸Šæ¬¡æ¯éš¾åº¦çš„æ€»é‡ï¼ˆåˆå§‹åŒ–ä¸º0ï¼‰
        let last = [0, 0, 0, 0];
        let series = diffList.map(() => []);
        for (let path of userGrowthFiles) {
          let data = await loadJSON(path);
          let user = Object.values(data).find(
            (d) => (d["å¤‡æ³¨"] || d["æ˜µç§°"] || "") === name
          );
          if (user && user["éš¾åº¦ç»Ÿè®¡"]) {
            diffList.forEach((item, i) => {
              let val = user["éš¾åº¦ç»Ÿè®¡"][item.name]?.["æ•°é‡"];
              if (typeof val !== "number") val = last[i];
              series[i].push(val);
              last[i] = val;
            });
          } else {
            // æ•°æ®ç¼ºå¤±æ—¶ï¼Œè¡¥ä¸Šä¸€æ¬¡
            last.forEach((v, i) => series[i].push(v));
          }
        }
        return series; // ç»“æ„ï¼š[ [å…¥é—¨...], [æ™®åŠ-...], ...]
      }

      // å·¥å…·å‡½æ•°ï¼šè¯»å–æœ¬åœ°json
      function loadJSON(path) {
        return fetch(path).then((res) => {
          if (!res.ok) throw new Error("è¯»å–å¤±è´¥");
          return res.json();
        });
      }

      // å·¥å…·å‡½æ•°ï¼šè¯»å–æœ¬åœ°csvä¸ºæ•°ç»„
      function loadCSV(path) {
        return fetch(path)
          .then((res) => {
            if (!res.ok) throw new Error("è¯»å–å¤±è´¥");
            return res.text();
          })
          .then((text) => {
            let lines = text.trim().split("\n");
            let header = lines[0].split("\t");
            if (header.length === 1) header = lines[0].split(",");
            let arr = [];
            for (let i = 1; i < lines.length; ++i) {
              let vals = lines[i].split("\t");
              if (vals.length === 1) vals = lines[i].split(",");
              let obj = {};
              header.forEach(
                (k, j) => (obj[k.trim()] = (vals[j] || "").trim())
              );
              arr.push(obj);
            }
            return arr;
          });
      }

      // æ–°å¢ï¼šè¯»å–must_map.jsonï¼ˆæˆ–060b6993-4fbe-40d0-a61a-983001b7f14c.jsonï¼‰
      function loadMustMap(path = "must_map.json") {
        return fetch(path).then((res) => {
          if (!res.ok) throw new Error("å¿…åšé¢˜æ¸…å•æœªæ‰¾åˆ°");
          return res.json();
        });
      }

      // å±•ç¤ºå†…å®¹èŒƒç•´å¿…åšé¢˜å®Œæˆæƒ…å†µï¼ˆuserï¼šå­¦ç”Ÿå¯¹è±¡ï¼ŒmustMapï¼šå¿…åšé¢˜mapï¼‰
      function showMustMap(user, mustMap) {
        if (!user || !mustMap) return;
        const area = document.getElementById("mustMapArea");
        area.innerHTML = "";
        const doneSet = new Set(user["æ‰€æœ‰é¢˜å·"] || []);
        Object.entries(mustMap).forEach(([cat, ids]) => {
          const catElem = document.createElement("div");
          catElem.className = "must-cat";
          catElem.textContent = cat;
          area.appendChild(catElem);
          const list = document.createElement("div");
          list.className = "must-list";
          (ids || []).forEach((qid) => {
            const item = document.createElement("span");
            item.className = "must-item" + (doneSet.has(qid) ? " done" : "");
            item.textContent = qid;
            list.appendChild(item);
          });
          area.appendChild(list);
        });
        document.getElementById("mustSection").style.display = "";
      }

      // ==================== å…¨å±€æ•°æ® ===================
      let students = [];
      let studentsRawData = {};
      let mustMap = null;
      let monthScores = [];

      // ==================== é¡µé¢åˆå§‹åŒ–æµç¨‹ ===================
      async function initPage() {
        try {
          const data = await loadJSON("data_2025-08-04.json");
          studentsRawData = data;
          students = Object.values(data).map((d) => ({
            name: d["å¤‡æ³¨"] || d["æ˜µç§°"] || "",
            allQids: d["æ‰€æœ‰é¢˜å·"] || [],
            total: d["æ€»é¢˜æ•°"] || 0,
            r: d["éš¾åº¦ç»Ÿè®¡"]?.["å…¥é—¨"]?.["æ•°é‡"] || 0,
            p: d["éš¾åº¦ç»Ÿè®¡"]?.["æ™®åŠ-"]?.["æ•°é‡"] || 0,
            t: d["éš¾åº¦ç»Ÿè®¡"]?.["æ™®åŠ/æé«˜-"]?.["æ•°é‡"] || 0,
            h: d["éš¾åº¦ç»Ÿè®¡"]?.["æé«˜+/çœé€‰-"]?.["æ•°é‡"] || 0,
            week: d["å‘¨å¢é‡"] || [0, 0, 0, 0, 0, 0, 0],
            raw: d,
          }));
          students.sort((a, b) => b.total - a.total);

          monthScores = await loadCSV("match_2025_08.csv");
          students.forEach((stu) => {
            let row = monthScores.find((row) => row["çœŸå®å§“å"] === stu.name);
            stu.y = row ? parseInt(row["æ€»åˆ†"]) : 0;
          });

          window.avgData = (() => {
            let n = students.length;
            let sum = {
              r: 0,
              p: 0,
              t: 0,
              h: 0,
              total: 0,
              y: 0,
              week: [0, 0, 0, 0, 0, 0, 0],
            };
            students.forEach((s) => {
              sum.r += s.r;
              sum.p += s.p;
              sum.t += s.t;
              sum.h += s.h;
              sum.total += s.total;
              sum.y += s.y;
              s.week?.forEach(
                (w, i) => (sum.week[i] = (sum.week[i] || 0) + (w || 0))
              );
            });
            return {
              r: Math.round(sum.r / n),
              p: Math.round(sum.p / n),
              t: Math.round(sum.t / n),
              h: Math.round(sum.h / n),
              total: Math.round(sum.total / n),
              y: Math.round(sum.y / n),
              week: sum.week.map((x) => Math.round(x / n)),
            };
          })();

          // åŠ è½½å¿…åšé¢˜
          mustMap = await loadMustMap();

          document.getElementById("mainView").style.display = "";
          renderBoardTable();
          showMainCharts();
          showGrowthRankView();
          if (location.hash.startsWith("#user=")) {
            let name = decodeURIComponent(location.hash.slice(6));
            let idx = students.findIndex((s) => s.name === name);
            if (idx > -1) showUserDetail(idx);
            else showMainPage();
          }
        } catch (e) {
          alert("æ•°æ®æ–‡ä»¶è¯»å–å¤±è´¥ï¼š" + e.message);
        }
      }

      // ==================== æ¦œå•æ¸²æŸ“ ===================
      function renderBoardTable(curUser) {
        let html = "";
        for (let i = 0; i < students.length; i++) {
          const s = students[i];
          if (s) {
            html += `<tr${
              curUser && curUser === s.name ? ' class="cur-user"' : ""
            }><td>${i + 1}</td>
        <td class="user-link" data-idx="${i}">${s.name}</td>
        <td>${s.total}</td>
        <td>${s.r}</td>
        <td>${s.p}</td>
        <td>${s.t}</td>
        <td>${s.h}</td>
      </tr>`;
          }
        }
        document.getElementById("student-table-body").innerHTML = html;
        Array.from(document.getElementsByClassName("user-link")).forEach(
          (e) => {
            e.onclick = () => showUserDetail(parseInt(e.dataset.idx));
          }
        );
      }

      // ==================== é¦–é¡µå››å›¾ ===================
      function showMainCharts() {
        let sum = { r: 0, p: 0, t: 0, h: 0 };
        students.forEach((s) => {
          sum.r += s.r;
          sum.p += s.p;
          sum.t += s.t;
          sum.h += s.h;
        });
        echarts.init(document.getElementById("main-pie")).setOption({
          tooltip: { trigger: "item" },
          legend: { bottom: 2 },
          color: ["#ffb700", "#ffa155", "#ff754a", "#ff4e50"],
          series: [
            {
              name: "éš¾åº¦åˆ†å¸ƒ",
              type: "pie",
              radius: "60%",
              data: [
                { value: sum.r, name: "å…¥é—¨é¢˜" },
                { value: sum.p, name: "æ™®åŠ-" },
                { value: sum.t, name: "æ™®åŠ/æé«˜-" },
                { value: sum.h, name: "é«˜éš¾åº¦" },
              ],
              label: { fontSize: 15 },
            },
          ],
        });
        // let weekSum = [0,0,0,0,0,0,0];
        // students.forEach(s=>s.week?.forEach((w,i)=>weekSum[i]+=w||0));
        // echarts.init(document.getElementById('main-line')).setOption({
        //   tooltip: { trigger: 'axis' },
        //   xAxis: { type: 'category', data: ['ç¬¬1å‘¨','ç¬¬2å‘¨','ç¬¬3å‘¨','ç¬¬4å‘¨','ç¬¬5å‘¨','ç¬¬6å‘¨','ç¬¬7å‘¨'] },
        //   yAxis: { type: 'value' },
        //   series: [{
        //     data: weekSum.map(x=>Math.round(x/students.length)),
        //     type: 'line',
        //     name: 'å¹³å‡åšé¢˜æ•°',
        //     symbol: 'circle', symbolSize: 12,
        //     lineStyle: { width: 4, color: '#ff8500' },
        //     itemStyle: { color: '#ff8500' }
        //   }]
        // });
        let nameField = "çœŸå®å§“å";
        let scoreField = "æ€»åˆ†";
        let monthScoresSorted = monthScores
          .map((row) => ({
            name: row[nameField],
            score: parseInt(row[scoreField]),
          }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 8);

        let reversedNames = monthScoresSorted.map((x) => x.name).reverse();
        let reversedScores = monthScoresSorted.map((x) => x.score).reverse();

        echarts.init(document.getElementById("main-bar")).setOption({
          grid: { left: 70, right: 30, top: 35, bottom: 15 },
          xAxis: { type: "value", min: 0 },
          yAxis: {
            type: "category",
            data: reversedNames,
            axisLabel: { fontSize: 16 },
          },
          series: [
            {
              type: "bar",
              data: reversedScores,
              itemStyle: { borderRadius: [0, 8, 8, 0], color: "#ff8500" },
              barWidth: 22,
              label: {
                show: true,
                position: "right",
                fontWeight: "bold",
                fontSize: 16,
                color: "#444",
                formatter: "{c}åˆ†",
              },
            },
          ],
        });
        echarts.init(document.getElementById("main-radar")).setOption({
          tooltip: { show: true },
          legend: {
            bottom: 7,
            data: ["ç­çº§å¹³å‡", "æœ€ä¼˜åŒå­¦"],
            textStyle: { fontSize: 15 },
          },
          radar: {
            indicator: [
              { name: "å…¥é—¨é¢˜", max: 60 },
              { name: "æ™®åŠ-", max: 80 },
              { name: "æ™®åŠ/æé«˜-", max: 90 },
              { name: "é«˜éš¾åº¦", max: 40 },
              { name: "æ€»é‡", max: 200 },
            ],
            radius: 105,
            center: ["50%", "50%"],
            splitArea: {
              areaStyle: {
                color: [
                  "rgba(255,133,0,0.12)",
                  "rgba(255,133,0,0.08)",
                  "rgba(255,133,0,0.06)",
                  "rgba(255,133,0,0.04)",
                  "rgba(255,133,0,0.01)",
                ],
              },
            },
            splitLine: {
              lineStyle: { color: "#ff8500", type: "dashed", width: 2 },
            },
            axisLine: { lineStyle: { color: "#ff8500", width: 1.2 } },
            axisName: { color: "#ff8500", fontSize: 15, fontWeight: "bold" },
          },
          series: [
            {
              name: "ç­çº§å¹³å‡ vs æœ€ä¼˜åŒå­¦",
              type: "radar",
              data: [
                {
                  value: [
                    window.avgData.r,
                    window.avgData.p,
                    window.avgData.t,
                    window.avgData.h,
                    window.avgData.total,
                  ],
                  name: "ç­çº§å¹³å‡",
                  areaStyle: { color: "rgba(255,133,0,0.13)" },
                },
                {
                  value: [
                    students[0].r,
                    students[0].p,
                    students[0].t,
                    students[0].h,
                    students[0].total,
                  ],
                  name: "æœ€ä¼˜åŒå­¦",
                  areaStyle: { color: "rgba(255,100,0,0.15)" },
                },
              ],
            },
          ],
        });
      }
      // ========== æ¯å‘¨è¿›æ­¥å† äºšå­£å›é¢†å¥–å° ==========

      // éœ€è¦ç”¨åˆ°çš„ä¸¤å‘¨æ•°æ®æ–‡ä»¶
      const weekDataFiles = ["data_2025-07-26.json", "data_2025-08-04.json"];

      // 1. è¯»å–ä¸¤å‘¨æ•°æ®ä¸º {å§“å: æ€»é¢˜æ•°}
      async function loadWeekData() {
        let weeks = [];
        for (let path of weekDataFiles) {
          const data = await loadJSON(path);
          let map = {};
          Object.values(data).forEach((d) => {
            const name = d["å¤‡æ³¨"] || d["æ˜µç§°"] || "";
            map[name] = d["æ€»é¢˜æ•°"] || 0;
          });
          weeks.push(map);
        }
        return weeks;
      }

      // 2. è®¡ç®—æ¯äººå¢é‡ï¼ŒæŒ‰é™åºæ’å‰å
      async function getTopGrowthRank() {
        let [last, now] = await loadWeekData();
        let growth = [];
        for (let name in now) {
          let prev = last[name] || 0;
          let delta = now[name] - prev;
          growth.push({ name, delta });
        }
        growth.sort((a, b) => b.delta - a.delta);
        return growth.slice(0, 10);
      }

      // 3. æ¸²æŸ“é¢†å¥–å°
      async function showGrowthRankView() {
        const growth = await getTopGrowthRank();
        if (!growth.length) {
          document.getElementById("growth-rank-view").innerHTML =
            '<div style="color:#bbb;text-align:center;">æš‚æ— æ•°æ®</div>';
          return;
        }
        // é¢†å¥–å°
        let medals = [
          '<span style="font-size:38px;">ğŸ¥‡</span>',
          '<span style="font-size:38px;">ğŸ¥ˆ</span>',
          '<span style="font-size:38px;">ğŸ¥‰</span>',
        ];
        let color = ["#FFD700", "#BFBFBF", "#DA8A34"]; // é‡‘é“¶é“œ
        let podiumH = [124, 88, 68];
        let marginT = [0, 36, 55];

        let podiumHtml = `
    <div style="display:flex;align-items:flex-end;justify-content:center;height:170px;gap:38px;margin-bottom:6px;">
      ${[1, 0, 2]
        .map((i) => {
          // å·¦-ä¸­-å³
          let s = growth[i];
          if (!s) return "";
          return `
            <div style="
              display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
              width:94px;position:relative;margin-top:${marginT[i]}px;">
              <div style="
                background:radial-gradient(ellipse at 55% 12%,#fffbe9 75%,${color[i]}44 100%);
                width:58px;height:${podiumH[i]}px;border-radius:13px 13px 18px 18px/19px 19px 24px 24px;
                box-shadow:0 9px 20px ${color[i]}33,0 1.5px 0 #eee;
                display:flex;align-items:flex-end;justify-content:center;
                border: 2.6px solid #ffeab0; font-size:22px; font-weight:bold;
                position:relative;">
                <span style="position:absolute;top:-40px;left:50%;transform:translateX(-50%);font-size:33px;text-shadow:0 4px 12px #fff1b599;">${medals[i]}</span>
                <span style="position:absolute;bottom:29px;left:50%;transform:translateX(-50%);font-size:23px;color:${color[i]};font-weight:bold;text-shadow:0 1.5px 8px #fff0 60%;">
                  +${s.delta}
                </span>
                <span style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:14px;color:#9d7c29;opacity:.75;">é¢˜</span>
              </div>
              <div style="font-size:18px;color:#ff8500;font-weight:bold;margin:13px 0 2px 0;text-shadow:0 2px 8px #ffe8ad60;">${s.name}</div>
            </div>
          `;
        })
        .join("")}
    </div>
  `;

        // å…¶ä»–ä¸Šæ¦œ
        let listHtml = "";
        if (growth.length > 3) {
          listHtml = `
      <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:0 12px;margin-top:12px;">
        ${growth
          .slice(3, 10)
          .map(
            (s, i) => `
          <div style="
            display:flex;align-items:center;gap:8px;
            background:#faf6e8;
            border-radius:14px;
            box-shadow:0 1.5px 7px #ffd67325;
            padding:5px 14px 4px 10px;
            font-size:15px;
            margin-bottom:7px;
            min-width:135px;
            ">
            <span style="font-weight:bold;color:#d49016;font-size:15.5px;width:1.8em;display:inline-block;text-align:right;">${
              i + 4
            }.</span>
            <span style="color:#666;font-weight:bold;margin-right:3px;">${
              s.name
            }</span>
            <span style="color:#119642;font-weight:bold;">+${s.delta}</span>
            <span style="color:#a08c5a;font-size:13px;">é¢˜</span>
          </div>
        `
          )
          .join("")}
      </div>
    `;
        }

        document.getElementById("growth-rank-view").innerHTML =
          podiumHtml + listHtml;
      }

      // ==================== ä¸ªäººé¡µé€»è¾‘ ===================
      function showUserDetail(idx) {
        let s = students[idx];
        document.getElementById("mainView").style.display = "none";
        document.getElementById("userDetailView").style.display = "flex";
        // å±•ç¤ºä¸ªäººå¡ç‰‡ä¿¡æ¯
        // å±•ç¤ºä¸ªäººå¡ç‰‡ä¿¡æ¯ï¼ˆç¾åŒ–ç‰ˆï¼‰
        document.getElementById("userCard").innerHTML = `
  <div style="
    background: linear-gradient(100deg, #fffbe7 70%, #ffe5c6 120%);
    border: 2.2px solid #ffbb32;
    box-shadow: 0 6px 32px #ffb70033, 0 1.5px 0 #ffd97b;
    border-radius: 30px;
    padding: 36px 38px 28px 38px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 220px;
    position: relative;
    margin: 0 auto;
  ">
    <!-- å¥–ç‰Œicon -->
    <div style="
      width: 54px; height: 54px;
      background: radial-gradient(circle at 65% 35%, #ffe88e 55%, #ffd32a 100%);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 18px #ffd32a33, 0 1.5px 0 #ffd32a77;
      margin-bottom: 18px;
      font-size: 32px;
      color: #ffb700;
      font-weight: bold;
      letter-spacing: 2px;
    ">ğŸ…</div>
    <div class="user-info-main" style="
      font-size: 28px;
      color: #ff8500;
      font-weight: bold;
      letter-spacing: 1.5px;
      margin-bottom: 10px;
      text-shadow: 0 2px 8px #ffbb3222;
      text-align: center;
    ">${s.name}</div>
    <div class="user-info-sec" style="
      font-size: 19px;
      color: #ff6d00;
      margin-bottom: 9px;
      font-weight: bold;
      letter-spacing: 1.2px;
      text-align: center;
      text-shadow: 0 1px 6px #ffd97b22;
    ">å·²å®Œæˆé¢˜ç›®ï¼š<span style="color:#00993d; font-size:24px;">${s.total}</span> é“</div>
    <div style="
      font-size: 15px;
      color: #997012;
      background: linear-gradient(100deg,#ffefbb 60%,#fff7ee 120%);
      border-radius: 8px;
      padding: 4px 18px 3px 18px;
      font-weight: 500;
      margin-top: 8px;
      box-shadow: 0 1px 5px #ffd97b11;
      letter-spacing: 0.5px;
    ">Keep Coding, Keep Growing!</div>
  </div>
`;

        // å›¾è¡¨...
        echarts.init(document.getElementById("user-pie")).setOption({
          tooltip: { trigger: "item" },
          legend: { bottom: 3 },
          color: ["#ffb700", "#ffa155", "#ff754a", "#ff4e50"],
          series: [
            {
              name: "éš¾åº¦åˆ†å¸ƒ",
              type: "pie",
              radius: "60%",
              data: [
                { value: s.r, name: "å…¥é—¨é¢˜" },
                { value: s.p, name: "æ™®åŠ-" },
                { value: s.t, name: "æ™®åŠ/æé«˜-" },
                { value: s.h, name: "é«˜éš¾åº¦" },
              ],
              label: { fontSize: 15 },
            },
          ],
        });
        // 1. å– userGrowthFiles çš„æ—¥æœŸä½œä¸ºæ¨ªåæ ‡æ ‡ç­¾
        const dateLabels = userGrowthFiles.map((path) => {
          const match = path.match(/\d{4}-\d{2}-\d{2}/);
          if (match) {
            const [year, month, day] = match[0].split("-");
            return `${parseInt(month)}/${parseInt(day)}`; // æ¯”å¦‚ 8/4
          }
          return path;
        });

        // 2. ç”¨ getUserTotalSeries è¯»å–å››ä¸ªéš¾åº¦å››å‘¨çš„æ€»é‡æ•°æ®
        getUserTotalSeries(s.name).then((series) => {
          echarts.init(document.getElementById("user-line")).setOption({
            tooltip: { trigger: "axis" },
            legend: {
              data: diffList.map((d) => d.name),
              top: 10,
              textStyle: { fontSize: 15 },
              itemWidth: 22,
              itemHeight: 12,
            },
            color: diffList.map((d) => d.color),
            xAxis: {
              type: "category",
              data: dateLabels,
              axisLabel: { fontSize: 15 },
            },
            yAxis: { type: "value", minInterval: 1 },
            series: diffList.map((d, i) => ({
              name: d.name,
              data: series[i],
              type: "line",
              smooth: true,
              symbol: "circle",
              symbolSize: 12,
              lineStyle: { width: 4, color: d.color },
              itemStyle: {
                color: d.color,
                borderColor: "#fff",
                borderWidth: 2,
              },
            })),
          });
        });
        let totalStudents = scoreRows.length;
        // 1. æ‰¾å‡ºæœ¬æœˆæˆç»©å’Œæ’åï¼ˆåªä¿ç•™ä¸€æ¬¡ï¼ï¼‰
      // 1. æ‰¾å‡ºæœ¬æœˆæˆç»©å’Œæ’å
let scoreRows = monthScores
  .map(row => ({
    name: row["çœŸå®å§“å"],
    score: parseInt(row["æ€»åˆ†"])
  }))
  .filter(row => !isNaN(row.score))
  .sort((a, b) => b.score - a.score);

let myScoreObj = scoreRows.find(row => row.name === s.name);
let myRank = myScoreObj ? scoreRows.findIndex(row => row.name === s.name) + 1 : null;


// 2. è®¡ç®—ç­‰çº§
let level = "";
if (!myScoreObj) {
  level = "æœªå‚èµ›";
} else if (myRank <= 2) {
  level = "ä¸€ç­‰å¥–";
} else if (myRank <= 8) {
  level = "äºŒç­‰å¥–";
} else if (myRank <= 20) {
  level = "ä¸‰ç­‰å¥–";
} else {
  level = "ä¼˜ç§€å¥–";
}

// 3. è®¡ç®—ç­‰çº§åŒºé—´æ¯”ä¾‹ï¼ˆç”¨äºä»ªè¡¨ç›˜æŒ‡é’ˆï¼‰ 0~1
let levelValue = 0;
if (!myScoreObj || myRank === null) {
  levelValue = 0;
} else if (myRank <= 2) {
  levelValue = 0.875;
} else if (myRank <= 8) {
  levelValue = 0.625;
} else if (myRank <= 20) {
  levelValue = 0.375;
} else {
  levelValue = 0.125;
}

// 4. ç”Ÿæˆæ–‡å­—æ˜¾ç¤º
let scoreText = "";
if (!myScoreObj || myRank === null) {
  scoreText =
    '<span style="font-size:19px;color:#bbb;font-style:italic;font-weight:normal;">æœªå‚åŠ æœ¬æ¬¡æœˆèµ›</span>';
} else {
  scoreText = `<span style="color:#ff8500;font-weight:bold;">ç­‰çº§ï¼š</span><span style="color:#ff8500;font-size:21px;font-weight:bold;">${level}</span>Â Â Â <span style="color:#ff8500;font-weight:bold;">|</span>Â Â Â <span style="color:#ff8500;font-weight:bold;">æ’åï¼š</span><span style="color:#ff8500;font-size:21px;font-weight:bold;">ç¬¬${myRank}å</span>Â Â Â <span style="color:#ff8500;font-weight:bold;">/ ${totalStudents}äºº</span>`;
}
document.getElementById("user-bar-title").innerHTML = scoreText;

// 5. æ¸²æŸ“ç­‰çº§ä»ªè¡¨ç›˜
echarts.init(document.getElementById("user-bar")).setOption({
  series: [
    {
      type: "gauge",
      startAngle: 180,
      endAngle: 0,
      center: ["50%", "72%"],  // æŒ‡é’ˆç•¥å¾®ä¸‹æ²‰
      radius: "94%",
      min: 0,
      max: 1,
      splitNumber: 4,
      axisLine: {
        lineStyle: {
          width: 18,
          color: [
            [0.25, "#7CFFB2"],
            [0.5, "#58D9F9"],
            [0.75, "#FDDD60"],
            [1, "#ff8500"]
          ],
          shadowBlur: 16,
          shadowColor: "#ff850022"
        }
      },
      pointer: {
        show: !!myScoreObj, // æœªå‚èµ›åˆ™éšè—æŒ‡é’ˆ
        icon: "path://M-6,-60 L0,-100 L6,-60 Q0,-50 -6,-60",
        length: "62%",
        width: 14,
        offsetCenter: [0, "6%"],
        itemStyle: {
          color: "#ff8500",
          shadowColor: "#ffcf3a66",
          shadowBlur: 6
        }
      },
      axisTick: {
        show: false
      },
      splitLine: {
        length: 30,
        lineStyle: { color: "#fff8e2", width: 4 }
      },
      axisLabel: {
        color: "#ff8500",
        fontSize: 18,
        fontWeight: "bold",
        distance: -56,
        formatter: function (val) {
          if (val === 0.875) return "ä¸€ç­‰å¥–";
          if (val === 0.625) return "äºŒç­‰å¥–";
          if (val === 0.375) return "ä¸‰ç­‰å¥–";
          if (val === 0.125) return "ä¼˜ç§€å¥–";
          return "";
        }
      },
      anchor: {
        show: !!myScoreObj,
        showAbove: true,
        size: 22,
        itemStyle: {
          color: "#fff3cc",
          borderWidth: 6,
          borderColor: "#ffcf3a"
        }
      },
      detail: {
        show: false
      },
      data: [
        {
          value: myScoreObj ? levelValue : 0
        }
      ]
    }
  ]
});


        // åŠ¨æ€ç”Ÿæˆæ’å/æœªå‚åŠ çš„å°å­—è¯´æ˜
        let infoHtml = "";

        document.getElementById("user-bar-info").innerHTML = infoHtml;

        echarts.init(document.getElementById("user-radar")).setOption({
          legend: {
            bottom: 5,
            data: ["ä¸ªäºº", "ç­çº§å¹³å‡"],
            textStyle: { fontSize: 15 },
          },
          radar: {
            indicator: [
              { name: "å…¥é—¨é¢˜", max: 60 },
              { name: "æ™®åŠ-", max: 80 },
              { name: "æ™®åŠ/æé«˜-", max: 90 },
              { name: "é«˜éš¾åº¦", max: 40 },
              { name: "æ€»é‡", max: 200 },
            ],
            radius: 90,
            center: ["50%", "50%"],
            splitArea: {
              areaStyle: {
                color: [
                  "rgba(255,133,0,0.12)",
                  "rgba(255,133,0,0.08)",
                  "rgba(255,133,0,0.06)",
                  "rgba(255,133,0,0.04)",
                  "rgba(255,133,0,0.01)",
                ],
              },
            },
            splitLine: {
              lineStyle: { color: "#ff8500", type: "dashed", width: 2 },
            },
            axisLine: { lineStyle: { color: "#ff8500", width: 1.2 } },
            axisName: { color: "#ff8500", fontSize: 15, fontWeight: "bold" },
          },
          series: [
            {
              type: "radar",
              data: [
                {
                  value: [s.r, s.p, s.t, s.h, s.total],
                  name: "ä¸ªäºº",
                  areaStyle: { color: "rgba(80,210,120,0.11)" },
                },
                {
                  value: [
                    window.avgData.r,
                    window.avgData.p,
                    window.avgData.t,
                    window.avgData.h,
                    window.avgData.total,
                  ],
                  name: "ç­çº§å¹³å‡",
                  areaStyle: { color: "rgba(255,133,0,0.13)" },
                },
              ],
            },
          ],
        });

        // æ¸²æŸ“å¿…åšé¢˜èŒƒç•´å®Œæˆæƒ…å†µ
        if (mustMap) {
          // æ‰¾åŸå§‹ student å¯¹è±¡ï¼ˆå› ä¸º students æ˜¯æ’åºè¿‡çš„ï¼ï¼‰
          let rawUser = Object.values(studentsRawData).find(
            (d) => (d["å¤‡æ³¨"] || d["æ˜µç§°"] || "") === s.name
          );
          showMustMap(rawUser, mustMap);
        } else {
          document.getElementById("mustSection").style.display = "none";
        }
        document.getElementById("backBtn").onclick = function () {
          document.getElementById("userDetailView").style.display = "none";
          document.getElementById("mainView").style.display = "";
          location.hash = "";
        };
        location.hash = "#user=" + encodeURIComponent(s.name);
      }

      // è¿”å›ä¸»é¡µé¢
      function showMainPage() {
        document.getElementById("mainView").style.display = "";
        document.getElementById("userDetailView").style.display = "none";
        location.hash = "";
      }

      // é¡¶éƒ¨æœç´¢åŠŸèƒ½
      function searchStudent() {
        let val = document.getElementById("stuSearchInput").value.trim();
        if (!val) {
          alert("è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼");
          return;
        }
        // æ”¯æŒæ¨¡ç³Š/ç²¾ç¡®ï¼ˆç²¾ç¡®ä¼˜å…ˆï¼‰
        let idx = students.findIndex((s) => s.name === val);
        if (idx === -1) {
          // å†å°è¯•å¿½ç•¥ç©ºæ ¼å’Œå¤§å°å†™
          idx = students.findIndex(
            (s) =>
              s.name.replace(/\s/g, "").toLowerCase() ===
              val.replace(/\s/g, "").toLowerCase()
          );
        }
        if (idx === -1) {
          // å°è¯•åŒ…å«
          idx = students.findIndex((s) => s.name.includes(val));
        }
        if (idx === -1) {
          alert("æ²¡æœ‰æ‰¾åˆ°è¯¥åŒå­¦ï¼Œè¯·æ ¸å¯¹å§“åï¼");
          return;
        }
        showUserDetail(idx);
        // æ¸…ç©ºæœç´¢æ¡†ï¼ˆä½“éªŒæ›´å¥½ï¼‰
        document.getElementById("stuSearchInput").value = "";
      }

      // è®©æ ‡é¢˜ç‚¹å‡»æ—¶è¿”å›ä¸»é¡µé¢
      document.getElementById("mainTitle").onclick = function () {
        showMainPage(); // è¿™ä¸ªæ˜¯ä½ åŸæ¥ js é‡Œçš„å‡½æ•°ï¼Œç›´æ¥å¤ç”¨
      };

      // é¡µé¢åˆå§‹åŒ–
      initPage();
    </script>
  </body>
</html>
